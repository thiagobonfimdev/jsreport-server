{"version":3,"file":"pivot-cache-records-xform.js","names":["XmlStream","require","BaseXform","PivotCacheRecordsXform","constructor","map","prepare","model","tag","render","xmlStream","sourceSheet","cacheFields","sourceBodyRows","getSheetValues","slice","openXml","StdDocAttributes","openNode","_objectSpread","PIVOT_CACHE_RECORDS_ATTRIBUTES","count","length","writeXml","renderTable","closeNode","rowsInXML","row","realRow","renderRowLines","join","index","cellValue","entries","renderCell","sharedItems","value","Number","isFinite","concat","sharedItemsIndex","indexOf","Error","JSON","stringify","parseOpen","node","parseText","text","parseClose","name","reconcile","options","xmlns","module","exports"],"sources":["../../../../../lib/xlsx/xform/pivot-table/pivot-cache-records-xform.js"],"sourcesContent":["const XmlStream = require('../../../utils/xml-stream');\n\nconst BaseXform = require('../base-xform');\n\nclass PivotCacheRecordsXform extends BaseXform {\n  constructor() {\n    super();\n\n    this.map = {};\n  }\n\n  prepare(model) {\n    // TK\n  }\n\n  get tag() {\n    // http://www.datypic.com/sc/ooxml/e-ssml_pivotCacheRecords.html\n    return 'pivotCacheRecords';\n  }\n\n  render(xmlStream, model) {\n    const {sourceSheet, cacheFields} = model;\n    const sourceBodyRows = sourceSheet.getSheetValues().slice(2);\n\n    xmlStream.openXml(XmlStream.StdDocAttributes);\n    xmlStream.openNode(this.tag, {\n      ...PivotCacheRecordsXform.PIVOT_CACHE_RECORDS_ATTRIBUTES,\n      count: sourceBodyRows.length,\n    });\n    xmlStream.writeXml(renderTable());\n    xmlStream.closeNode();\n\n    // Helpers\n\n    function renderTable() {\n      const rowsInXML = sourceBodyRows.map(row => {\n        const realRow = row.slice(1);\n        return [...renderRowLines(realRow)].join('');\n      });\n      return rowsInXML.join('');\n    }\n\n    function* renderRowLines(row) {\n      // PivotCache Record: http://www.datypic.com/sc/ooxml/e-ssml_r-1.html\n      // Note: pretty-printing this for now to ease debugging.\n      yield '\\n  <r>';\n      for (const [index, cellValue] of row.entries()) {\n        yield '\\n    ';\n        yield renderCell(cellValue, cacheFields[index].sharedItems);\n      }\n      yield '\\n  </r>';\n    }\n\n    function renderCell(value, sharedItems) {\n      // no shared items\n      // --------------------------------------------------\n      if (sharedItems === null) {\n        if (Number.isFinite(value)) {\n          // Numeric value: http://www.datypic.com/sc/ooxml/e-ssml_n-2.html\n          return `<n v=\"${value}\" />`;\n        }\n          // Character Value: http://www.datypic.com/sc/ooxml/e-ssml_s-2.html\n          return `<s v=\"${value}\" />`;\n        \n      }\n\n      // shared items\n      // --------------------------------------------------\n      const sharedItemsIndex = sharedItems.indexOf(value);\n      if (sharedItemsIndex < 0) {\n        throw new Error(`${JSON.stringify(value)} not in sharedItems ${JSON.stringify(sharedItems)}`);\n      }\n      // Shared Items Index: http://www.datypic.com/sc/ooxml/e-ssml_x-9.html\n      return `<x v=\"${sharedItemsIndex}\" />`;\n    }\n  }\n\n  parseOpen(node) {\n    // TK\n  }\n\n  parseText(text) {\n    // TK\n  }\n\n  parseClose(name) {\n    // TK\n  }\n\n  reconcile(model, options) {\n    // TK\n  }\n}\n\nPivotCacheRecordsXform.PIVOT_CACHE_RECORDS_ATTRIBUTES = {\n  xmlns: 'http://schemas.openxmlformats.org/spreadsheetml/2006/main',\n  'xmlns:r': 'http://schemas.openxmlformats.org/officeDocument/2006/relationships',\n  'xmlns:mc': 'http://schemas.openxmlformats.org/markup-compatibility/2006',\n  'mc:Ignorable': 'xr',\n  'xmlns:xr': 'http://schemas.microsoft.com/office/spreadsheetml/2014/revision',\n};\n\nmodule.exports = PivotCacheRecordsXform;\n"],"mappings":"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","ignoreList":[]}