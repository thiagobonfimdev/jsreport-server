{"version":3,"file":"workbook-writer.js","names":["StringDecoder","require","Readable","Transform","DOMParser","fs","Archiver","unzip","tmp","StreamBuf","RelType","StylesXform","SharedStrings","DefinedNames","CoreXform","RelationshipsXform","ContentTypesXform","AppXform","WorkbookXform","SharedStringsXform","WorksheetWriter","theme1Xml","WorkbookWriter","constructor","options","created","Date","modified","creator","lastModifiedBy","lastPrinted","useSharedStrings","sharedStrings","template","styles","useStyles","Mock","_definedNames","_worksheets","_tmpWorksheets","Map","_cellStylesCache","views","zipOptions","zip","media","commentRefs","templateBuf","templateWrites","templateInfo","templateZip","Parse","stream","filename","createWriteStream","pipe","promise","Promise","resolve","all","addThemes","addOfficeRels","definedNames","_getNextWorksheetId","name","id","existingWorkSheet","sheets","find","s","sheetFileId","nextId","_openStream","path","sheetId","bufSize","batch","isWorksheet","has","tmpWorksheet","get","zipEntryPath","tmpWriteStream","tmpPath","waitComplete","reject","on","append","emit","_commitWorksheets","commitWorksheet","worksheet","committed","commit","promises","map","length","waitForTemplateParse","templateStream","from","objectMode","files","pendingOperations","waitingWorkSheets","entry","push","parseXMLFile","match","_resolve","_reject","file","err","tmpFilePath","tempStream","ref","filesDocuments","workbookDoc","doc","relsDoc","lastSheetId","lastSheetFileId","Array","getElementsByTagName","sheetNode","parseInt","getAttribute","rId","targetRNode","rNode","sheetFile","sheetFileFound","w","concat","sheetFileSrc","parseStream","originalSrc","lastWorkbookRelsId","reduce","acu","relNode","rIdNumber","addMedia","newWorksheets","newWorksheetsColsWidth","forEach","isArray","_columns","set","c","number","_number","width","replacedWorksheets","sheet","existingWorksheetIndex","findIndex","replaced","calcCells","_calcCells","splice","createReadStream","filter","fileName","fileDoc","Object","entries","content","sheetNodeRef","node","newWorksheet","newWorkSheetRef","cloneNode","setAttribute","parentNode","insertBefore","nextSibling","toString","xml","sheetsNode","i","newSheetNode","createElement","appendChild","relationshipsNode","newRelNode","calcChainNode","cellRefNodes","existingCalcCells","cellRefNode","worksheetIndex","cellRef","replacedWorksheetFound","removeChild","replacedWorksheet","calcCellsInWorksheet","cellAddress","newCellRef","addContentTypes","addApp","addCore","addSharedStrings","addStyles","addWorkbookRels","addWorkbook","tmpWorksheetCompletePromises","value","worksheetsToCopy","worksheetStream","decoder","placeholderFound","distStream","transform","chunk","enc","cb","chunkStr","write","includes","colsXML","rawColsXML","slice","replace","flush","str","end","result","_finalize","existingSheetsId","existingSheets","values","o","addImage","image","medium","assign","type","extension","getImage","addWorksheet","undefined","tabColor","console","trace","properties","async","workbook","state","pageSetup","autoFilter","headerFooter","addWorksheetAsync","_objectSpread","getWorksheet","xform","toXml","Id","Type","OfficeDocument","Target","CoreProperties","ExtenderProperties","model","worksheets","Boolean","buffer","base64","dataimg64","substring","indexOf","Error","coreXform","count","sharedStringsXform","relationships","Styles","Theme","Worksheet","calcProperties","prepare","finalize","parseFromString","module","exports"],"sources":["../../../../lib/stream/xlsx/workbook-writer.js"],"sourcesContent":["const {StringDecoder} = require('string_decoder');\nconst {Readable, Transform} = require('stream');\nconst {DOMParser} = require('@xmldom/xmldom');\nconst fs = require('fs');\nconst Archiver = require('archiver');\nconst unzip = require('unzipper');\n\nconst tmp = require('tmp');\nconst StreamBuf = require('../../utils/stream-buf');\n\nconst RelType = require('../../xlsx/rel-type');\nconst StylesXform = require('../../xlsx/xform/style/styles-xform');\nconst SharedStrings = require('../../utils/shared-strings');\nconst DefinedNames = require('../../doc/defined-names');\n\nconst CoreXform = require('../../xlsx/xform/core/core-xform');\nconst RelationshipsXform = require('../../xlsx/xform/core/relationships-xform');\nconst ContentTypesXform = require('../../xlsx/xform/core/content-types-xform');\nconst AppXform = require('../../xlsx/xform/core/app-xform');\nconst WorkbookXform = require('../../xlsx/xform/book/workbook-xform');\nconst SharedStringsXform = require('../../xlsx/xform/strings/shared-strings-xform');\n\nconst WorksheetWriter = require('./worksheet-writer');\n\nconst theme1Xml = require('../../xlsx/xml/theme1');\n\nclass WorkbookWriter {\n  constructor(options) {\n    options = options || {};\n\n    this.created = options.created || new Date();\n    this.modified = options.modified || this.created;\n    this.creator = options.creator || 'ExcelJS';\n    this.lastModifiedBy = options.lastModifiedBy || 'ExcelJS';\n    this.lastPrinted = options.lastPrinted;\n\n    // using shared strings creates a smaller xlsx file but may use more memory\n    this.useSharedStrings = options.useSharedStrings || false;\n    this.sharedStrings = new SharedStrings();\n\n    // style manager\n    if (options.template) {\n      this.styles = new StylesXform(true);\n    } else {\n      this.styles = options.useStyles ? new StylesXform(true) : new StylesXform.Mock(true);\n    }\n\n    // defined names\n    this._definedNames = new DefinedNames();\n\n    this._worksheets = [];\n    this._tmpWorksheets = new Map();\n    this._cellStylesCache = new Map();\n    this.views = [];\n\n    this.zipOptions = options.zip;\n\n    this.media = [];\n    this.commentRefs = [];\n\n    if (options.template) {\n      this.templateBuf = options.template;\n      this.templateWrites = [];\n      this.templateInfo = {};\n      this.templateZip = unzip.Parse();\n    }\n\n    this.zip = Archiver('zip', this.zipOptions);\n    if (options.stream) {\n      this.stream = options.stream;\n    } else if (options.filename) {\n      this.stream = fs.createWriteStream(options.filename);\n    } else {\n      this.stream = new StreamBuf();\n    }\n    this.zip.pipe(this.stream);\n\n    // these bits can be added right now\n    if (options.template) {\n      this.promise = new Promise(resolve => resolve());\n    } else {\n      // these bits can be added right now\n      this.promise = Promise.all([this.addThemes(), this.addOfficeRels()]);\n    }\n  }\n\n  get definedNames() {\n    return this._definedNames;\n  }\n\n  _getNextWorksheetId(name) {\n    let id;\n\n    if (this.templateInfo) {\n      const existingWorkSheet = this.templateInfo.sheets.find(s => s.name === name);\n\n      if (existingWorkSheet) {\n        id = existingWorkSheet.sheetFileId;\n      } else {\n        id = this.nextId;\n      }\n    } else {\n      id = this.nextId;\n    }\n\n    return id;\n  }\n\n  _openStream(path, sheetId) {\n    const stream = new StreamBuf({bufSize: 65536, batch: true});\n    const isWorksheet = sheetId != null;\n\n    if (isWorksheet && this._tmpWorksheets.has(sheetId)) {\n      const tmpWorksheet = this._tmpWorksheets.get(sheetId);\n      tmpWorksheet.zipEntryPath = path;\n\n      const tmpWriteStream = fs.createWriteStream(tmpWorksheet.tmpPath);\n\n      tmpWorksheet.waitComplete = new Promise((resolve, reject) => {\n        tmpWriteStream.on('error', reject);\n        tmpWriteStream.on('finish', resolve);\n      });\n\n      stream.pipe(tmpWriteStream);\n    } else {\n      this.zip.append(stream, {name: path});\n    }\n\n    stream.on('finish', () => {\n      stream.emit('zipped');\n    });\n    return stream;\n  }\n\n  _commitWorksheets() {\n    const commitWorksheet = function(worksheet) {\n      if (!worksheet.committed) {\n        return new Promise(resolve => {\n          worksheet.stream.on('zipped', () => {\n            resolve();\n          });\n          worksheet.commit();\n        });\n      }\n      return Promise.resolve();\n    };\n    // if there are any uncommitted worksheets, commit them now and wait\n    const promises = this._worksheets.map(commitWorksheet);\n    if (promises.length) {\n      return Promise.all(promises);\n    }\n    return Promise.resolve();\n  }\n\n  async waitForTemplateParse() {\n    const templateStream = Readable.from(this.templateBuf, {\n      objectMode: false,\n    });\n\n    const files = {};\n    const pendingOperations = [];\n    const waitingWorkSheets = [];\n\n    await new Promise((resolve, reject) => {\n      this.templateZip.on('entry', entry => {\n        switch (entry.path) {\n          case '[Content_Types].xml':\n          case 'xl/styles.xml':\n          case 'xl/workbook.xml':\n          case 'xl/_rels/workbook.xml.rels':\n          case 'xl/calcChain.xml':\n            pendingOperations.push(parseXMLFile(files, entry));\n            break;\n          default:\n            if (entry.path.match(/xl\\/worksheets\\/sheet\\d+[.]xml/)) {\n              pendingOperations.push(new Promise((_resolve, _reject) => {\n                // eslint-disable-next-line consistent-return\n                tmp.file((err, tmpFilePath) => {\n                  if (err) { return reject(err); }\n\n                  const tempStream = fs.createWriteStream(tmpFilePath);\n\n                  waitingWorkSheets.push({\n                    ref: entry.path,\n                    path: tmpFilePath,\n                  });\n\n                  entry.on('error', _reject);\n                  tempStream.on('error', _reject);\n                  tempStream.on('finish', _resolve);\n\n                  entry.pipe(tempStream);\n                });\n              }));\n            } else {\n              this.templateWrites.push(new Promise(_resolve => {\n                this.zip.append(entry, {name: entry.path});\n                _resolve();\n              }));\n            }\n            break;\n        }\n      });\n\n      this.templateZip.on('close', () => {\n        resolve();\n      });\n\n      this.templateZip.on('error', reject);\n\n      templateStream.pipe(this.templateZip);\n    });\n\n    await Promise.all(pendingOperations);\n\n    this.templateInfo.filesDocuments = files;\n\n    const workbookDoc = this.templateInfo.filesDocuments['xl/workbook.xml'].doc;\n    const relsDoc = this.templateInfo.filesDocuments['xl/_rels/workbook.xml.rels'].doc;\n\n    let lastSheetId;\n    let lastSheetFileId;\n\n    const sheets = Array.from(workbookDoc.getElementsByTagName('sheet')).map(sheetNode => {\n      const sheetId = parseInt(sheetNode.getAttribute('sheetId'), 10);\n      const rId = sheetNode.getAttribute('r:id');\n      const targetRNode = Array.from(relsDoc.getElementsByTagName('Relationship')).find(rNode => rNode.getAttribute('Id') === rId);\n      const sheetFile = targetRNode.getAttribute('Target');\n      const sheetFileId = parseInt(sheetFile.match(/worksheets\\/sheet(\\d+)[.]xml/)[1], 10);\n      const sheetFileFound = waitingWorkSheets.find(w => w.ref === `xl/worksheets/sheet${sheetFileId}.xml`);\n\n      if (lastSheetId == null || lastSheetId < sheetId) {\n        lastSheetId = sheetId;\n      }\n\n      if (lastSheetFileId == null || lastSheetFileId < sheetFileId) {\n        lastSheetFileId = sheetFileId;\n      }\n\n      return {\n        id: sheetId,\n        name: sheetNode.getAttribute('name'),\n        rId,\n        sheetFile,\n        sheetFileId,\n        sheetFileSrc: {\n          path: sheetFileFound.path,\n        },\n      };\n    });\n\n    // take existing styles from template as the base of new styles\n    await this.styles.parseStream(\n      Readable.from(this.templateInfo.filesDocuments['xl/styles.xml'].originalSrc, {\n        objectMode: false,\n      })\n    );\n\n    const lastWorkbookRelsId = Array.from(\n      relsDoc.getElementsByTagName('Relationship')\n    ).reduce((acu, relNode) => {\n      const rId = relNode.getAttribute('Id');\n      const rIdNumber = parseInt(rId.match(/rId(\\d+)/)[1], 10);\n\n      if (rIdNumber > acu) {\n        return rIdNumber;\n      }\n\n      return acu;\n    }, 0);\n\n    this.templateInfo.sheets = sheets;\n    this.templateInfo.lastSheetId = lastSheetId;\n    this.templateInfo.lastSheetFileId = lastSheetFileId;\n    this.templateInfo.lastWorkbookRelsId = lastWorkbookRelsId;\n  }\n\n  async commit() {\n    // commit all worksheets, then add supplementary files\n    await this.promise;\n\n    if (this.templateWrites) {\n      await Promise.all(this.templateWrites);\n    }\n\n    await this.addMedia();\n\n    const newWorksheets = [];\n    const newWorksheetsColsWidth = new Map();\n\n    this._worksheets.forEach(w => {\n      if (w == null) {\n        return;\n      }\n\n      // eslint-disable-next-line no-underscore-dangle\n      if (Array.isArray(w._columns)) {\n        // eslint-disable-next-line no-underscore-dangle\n        newWorksheetsColsWidth.set(w.id, w._columns.map(c => {\n          return {\n            // eslint-disable-next-line no-underscore-dangle\n            number: c._number,\n            width: c.width,\n          };\n        }));\n      }\n\n      newWorksheets.push(w);\n    });\n\n    let replacedWorksheets = [];\n\n    if (this.templateInfo) {\n      this.templateInfo.sheets.forEach(sheet => {\n        const existingWorksheetIndex = newWorksheets.findIndex(w => w.name === sheet.name);\n\n        if (existingWorksheetIndex !== -1) {\n          sheet.replaced = true;\n          // eslint-disable-next-line no-underscore-dangle\n          sheet.calcCells = newWorksheets[existingWorksheetIndex]._calcCells;\n          newWorksheets.splice(existingWorksheetIndex, 1);\n          return;\n        }\n\n        this.zip.append(fs.createReadStream(sheet.sheetFileSrc.path), {\n          name: `xl/worksheets/sheet${sheet.sheetFileId}.xml`,\n        });\n      });\n\n      replacedWorksheets = this.templateInfo.sheets.filter(s => s.replaced === true);\n    }\n\n    await this._commitWorksheets();\n\n    if (this.templateInfo) {\n      // eslint-disable-next-line no-restricted-syntax\n      for (const [fileName, {doc: fileDoc, originalSrc}] of Object.entries(this.templateInfo.filesDocuments)) {\n        let content = originalSrc;\n\n        if (fileName === '[Content_Types].xml' && newWorksheets.length > 0) {\n          const sheetNodeRef = Array.from(\n            fileDoc.getElementsByTagName('Override')\n          ).find(node => {\n            return node.getAttribute('PartName') === `/xl/worksheets/sheet${this.templateInfo.lastSheetFileId}.xml`;\n          });\n\n          // eslint-disable-next-line no-restricted-syntax\n          for (const newWorksheet of newWorksheets) {\n            const newWorkSheetRef = sheetNodeRef.cloneNode();\n            newWorkSheetRef.setAttribute('PartName', `/xl/worksheets/sheet${newWorksheet.id}.xml`);\n            sheetNodeRef.parentNode.insertBefore(newWorkSheetRef, sheetNodeRef.nextSibling);\n          }\n\n          content = fileDoc.toString();\n        } else if (fileName === 'xl/styles.xml') {\n          content = this.styles.xml;\n        } else if (fileName === 'xl/workbook.xml' && newWorksheets.length > 0) {\n          const sheetsNode = fileDoc.getElementsByTagName('sheets')[0];\n\n          for (let i = 0; i < newWorksheets.length; i++) {\n            const newWorksheet = newWorksheets[i];\n            const newSheetNode = fileDoc.createElement('sheet');\n            newSheetNode.setAttribute('name', newWorksheet.name);\n            newSheetNode.setAttribute('sheetId', this.templateInfo.lastSheetId + i + 1);\n            newSheetNode.setAttribute('r:id', `rId${this.templateInfo.lastWorkbookRelsId + i + 1}`);\n            sheetsNode.appendChild(newSheetNode);\n          }\n\n          content = fileDoc.toString();\n        } else if (fileName === 'xl/_rels/workbook.xml.rels' && newWorksheets.length > 0) {\n          const relationshipsNode = fileDoc.getElementsByTagName('Relationships')[0];\n\n          for (let i = 0; i < newWorksheets.length; i++) {\n            const newWorksheet = newWorksheets[i];\n            const newRelNode = fileDoc.createElement('Relationship');\n            newRelNode.setAttribute('Id', `rId${this.templateInfo.lastWorkbookRelsId + i + 1}`);\n            newRelNode.setAttribute('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet');\n            newRelNode.setAttribute('Target', `worksheets/sheet${newWorksheet.id}.xml`);\n            relationshipsNode.appendChild(newRelNode);\n          }\n\n          content = fileDoc.toString();\n        } else if (fileName === 'xl/calcChain.xml' && replacedWorksheets.length > 0) {\n          const calcChainNode = fileDoc.getElementsByTagName('calcChain')[0];\n          const cellRefNodes = Array.from(fileDoc.getElementsByTagName('c'));\n\n          const existingCalcCells = {};\n\n          cellRefNodes.forEach(cellRefNode => {\n            const worksheetIndex = parseInt(cellRefNode.getAttribute('i'), 10);\n            const cellRef = cellRefNode.getAttribute('r');\n            const replacedWorksheetFound = replacedWorksheets.find(w => w.id === worksheetIndex);\n\n            if (!replacedWorksheetFound) {\n              return;\n            }\n\n            if (!replacedWorksheetFound.calcCells[cellRef]) {\n              cellRefNode.parentNode.removeChild(cellRefNode);\n            } else {\n              existingCalcCells[worksheetIndex] = existingCalcCells[worksheetIndex] || {};\n              existingCalcCells[worksheetIndex][cellRef] = true;\n            }\n          });\n\n          replacedWorksheets.forEach(replacedWorksheet => {\n            const calcCellsInWorksheet = existingCalcCells[replacedWorksheet.id] || {};\n\n            // eslint-disable-next-line no-restricted-syntax\n            for (const [cellAddress] of Object.entries(replacedWorksheet.calcCells)) {\n              if (!calcCellsInWorksheet[cellAddress]) {\n                const newCellRef = fileDoc.createElement('c');\n                newCellRef.setAttribute('r', cellAddress);\n                newCellRef.setAttribute('i', replacedWorksheet.id);\n                calcChainNode.appendChild(newCellRef);\n              }\n            }\n          });\n\n          content = fileDoc.toString();\n        }\n\n        this.zip.append(content, {\n          name: fileName,\n        });\n      }\n    } else {\n      await Promise.all([\n        this.addContentTypes(),\n        this.addApp(),\n        this.addCore(),\n        this.addSharedStrings(),\n        this.addStyles(),\n        this.addWorkbookRels(),\n      ]);\n\n      await this.addWorkbook();\n    }\n\n    const tmpWorksheetCompletePromises = [];\n\n    this._tmpWorksheets.forEach(value => {\n      tmpWorksheetCompletePromises.push(value.waitComplete);\n    });\n\n    await Promise.all(tmpWorksheetCompletePromises);\n\n    const worksheetsToCopy = [];\n\n    // eslint-disable-next-line no-restricted-syntax\n    for (const [sheetId, tmpWorksheet] of this._tmpWorksheets.entries()) {\n      worksheetsToCopy.push({\n        sheetId,\n        tmpWorksheet,\n      });\n    }\n\n    // eslint-disable-next-line no-restricted-syntax\n    for (const w of worksheetsToCopy) {\n      const {sheetId, tmpWorksheet} = w;\n\n      // eslint-disable-next-line no-await-in-loop\n      await new Promise((resolve, reject) => {\n        const worksheetStream = fs.createReadStream(tmpWorksheet.tmpPath);\n        const decoder = new StringDecoder('utf8');\n        let placeholderFound = false;\n\n        const distStream = new Transform({\n          transform: (chunk, enc, cb) => {\n            const chunkStr = decoder.write(chunk);\n\n            if (!placeholderFound && chunkStr.includes('$colsContent')) {\n              placeholderFound = true;\n              let colsXML = this._worksheets[sheetId].rawColsXML;\n\n              colsXML = colsXML.slice('<cols>'.length).slice(0, '</cols>'.length * -1);\n\n              cb(null, chunkStr.replace('$colsContent', colsXML));\n            } else {\n              cb(null, chunkStr);\n            }\n          },\n          flush: cb => {\n            const str = decoder.end();\n\n            if (str !== '') {\n              cb(null, str);\n            } else {\n              cb();\n            }\n          },\n        });\n\n        distStream.on('finish', resolve);\n        worksheetStream.on('error', reject);\n        distStream.on('error', reject);\n\n        this.zip.append(distStream, {\n          name: tmpWorksheet.zipEntryPath,\n        });\n\n        worksheetStream.pipe(distStream);\n      });\n    }\n\n    const result = await this._finalize();\n\n    return result;\n  }\n\n  get nextId() {\n    let id;\n    // find the next unique spot to add worksheet\n    let i;\n\n    if (this.templateInfo && this.templateInfo.lastSheetFileId != null) {\n      const existingSheetsId = this.templateInfo.sheets.map(s => s.sheetFileId);\n\n      const existingSheets = Object.values(this._worksheets).filter(o => {\n        return existingSheetsId.includes(o.id) === false;\n      });\n\n      return this.templateInfo.lastSheetFileId + existingSheets.length + 1;\n    }\n\n    for (i = 1; i < this._worksheets.length; i++) {\n      if (!this._worksheets[i]) {\n        id = i;\n        break;\n      }\n    }\n\n    if (id == null) {\n      id = this._worksheets.length || 1;\n    }\n\n    return id;\n  }\n\n  addImage(image) {\n    const id = this.media.length;\n    const medium = Object.assign({}, image, {type: 'image', name: `image${id}.${image.extension}`});\n    this.media.push(medium);\n    return id;\n  }\n\n  getImage(id) {\n    return this.media[id];\n  }\n\n  addWorksheet(name, options) {\n    // it's possible to add a worksheet with different than default\n    // shared string handling\n    // in fact, it's even possible to switch it mid-sheet\n    options = options || {};\n    const useSharedStrings =\n      options.useSharedStrings !== undefined ? options.useSharedStrings : this.useSharedStrings;\n\n    if (options.tabColor) {\n      // eslint-disable-next-line no-console\n      console.trace('tabColor option has moved to { properties: tabColor: {...} }');\n      options.properties = Object.assign(\n        {\n          tabColor: options.tabColor,\n        },\n        options.properties\n      );\n    }\n\n    let id;\n\n    if (options.id) {\n      // eslint-disable-next-line prefer-destructuring\n      id = options.id;\n      delete options.id;\n    } else {\n      id = this._getNextWorksheetId(name);\n    }\n\n    name = name || `sheet${id}`;\n\n    const worksheet = new WorksheetWriter({\n      id,\n      name,\n      async: options.async === true,\n      workbook: this,\n      useSharedStrings,\n      properties: options.properties,\n      state: options.state,\n      pageSetup: options.pageSetup,\n      views: options.views,\n      autoFilter: options.autoFilter,\n      headerFooter: options.headerFooter,\n    });\n\n    this._worksheets[id] = worksheet;\n    return worksheet;\n  }\n\n  async addWorksheetAsync(name, options) {\n    const id = this._getNextWorksheetId(name);\n\n    const tmpPath = await new Promise((resolve, reject) => {\n      // eslint-disable-next-line consistent-return\n      tmp.file((err, tmpFilePath) => {\n        if (err) { return reject(err); }\n        resolve(tmpFilePath);\n      });\n    });\n\n    this._tmpWorksheets.set(id, {\n      tmpPath,\n    });\n\n    return this.addWorksheet(name, {\n      ...options,\n      async: true,\n      id,\n    });\n  }\n\n  getWorksheet(id) {\n    if (id === undefined) {\n      return this._worksheets.find(() => true);\n    }\n    if (typeof id === 'number') {\n      return this._worksheets[id];\n    }\n    if (typeof id === 'string') {\n      return this._worksheets.find(worksheet => worksheet && worksheet.name === id);\n    }\n    return undefined;\n  }\n\n  addStyles() {\n    return new Promise(resolve => {\n      this.zip.append(this.styles.xml, {name: 'xl/styles.xml'});\n      resolve();\n    });\n  }\n\n  addThemes() {\n    return new Promise(resolve => {\n      this.zip.append(theme1Xml, {name: 'xl/theme/theme1.xml'});\n      resolve();\n    });\n  }\n\n  addOfficeRels() {\n    return new Promise(resolve => {\n      const xform = new RelationshipsXform();\n      const xml = xform.toXml([\n        {Id: 'rId1', Type: RelType.OfficeDocument, Target: 'xl/workbook.xml'},\n        {Id: 'rId2', Type: RelType.CoreProperties, Target: 'docProps/core.xml'},\n        {Id: 'rId3', Type: RelType.ExtenderProperties, Target: 'docProps/app.xml'},\n      ]);\n      this.zip.append(xml, {name: '/_rels/.rels'});\n      resolve();\n    });\n  }\n\n  addContentTypes() {\n    return new Promise(resolve => {\n      const model = {\n        worksheets: this._worksheets.filter(Boolean),\n        sharedStrings: this.sharedStrings,\n        commentRefs: this.commentRefs,\n        media: this.media,\n      };\n      const xform = new ContentTypesXform();\n      const xml = xform.toXml(model);\n      this.zip.append(xml, {name: '[Content_Types].xml'});\n      resolve();\n    });\n  }\n\n  addMedia() {\n    return Promise.all(\n      this.media.map(medium => {\n        if (medium.type === 'image') {\n          const filename = `xl/media/${medium.name}`;\n          if (medium.filename) {\n            return this.zip.file(medium.filename, {name: filename});\n          }\n          if (medium.buffer) {\n            return this.zip.append(medium.buffer, {name: filename});\n          }\n          if (medium.base64) {\n            const dataimg64 = medium.base64;\n            const content = dataimg64.substring(dataimg64.indexOf(',') + 1);\n            return this.zip.append(content, {name: filename, base64: true});\n          }\n        }\n        throw new Error('Unsupported media');\n      })\n    );\n  }\n\n  addApp() {\n    return new Promise(resolve => {\n      const model = {\n        worksheets: this._worksheets.filter(Boolean),\n      };\n      const xform = new AppXform();\n      const xml = xform.toXml(model);\n      this.zip.append(xml, {name: 'docProps/app.xml'});\n      resolve();\n    });\n  }\n\n  addCore() {\n    return new Promise(resolve => {\n      const coreXform = new CoreXform();\n      const xml = coreXform.toXml(this);\n      this.zip.append(xml, {name: 'docProps/core.xml'});\n      resolve();\n    });\n  }\n\n  addSharedStrings() {\n    if (this.sharedStrings.count) {\n      return new Promise(resolve => {\n        const sharedStringsXform = new SharedStringsXform();\n        const xml = sharedStringsXform.toXml(this.sharedStrings);\n        this.zip.append(xml, {name: '/xl/sharedStrings.xml'});\n        resolve();\n      });\n    }\n    return Promise.resolve();\n  }\n\n  addWorkbookRels() {\n    let count = 1;\n    const relationships = [\n      {Id: `rId${count++}`, Type: RelType.Styles, Target: 'styles.xml'},\n      {Id: `rId${count++}`, Type: RelType.Theme, Target: 'theme/theme1.xml'},\n    ];\n    if (this.sharedStrings.count) {\n      relationships.push({\n        Id: `rId${count++}`,\n        Type: RelType.SharedStrings,\n        Target: 'sharedStrings.xml',\n      });\n    }\n    this._worksheets.forEach(worksheet => {\n      if (worksheet) {\n        worksheet.rId = `rId${count++}`;\n        relationships.push({\n          Id: worksheet.rId,\n          Type: RelType.Worksheet,\n          Target: `worksheets/sheet${worksheet.id}.xml`,\n        });\n      }\n    });\n    return new Promise(resolve => {\n      const xform = new RelationshipsXform();\n      const xml = xform.toXml(relationships);\n      this.zip.append(xml, {name: '/xl/_rels/workbook.xml.rels'});\n      resolve();\n    });\n  }\n\n  addWorkbook() {\n    const {zip} = this;\n    const model = {\n      worksheets: this._worksheets.filter(Boolean),\n      definedNames: this._definedNames.model,\n      views: this.views,\n      properties: {},\n      calcProperties: {},\n    };\n\n    return new Promise(resolve => {\n      const xform = new WorkbookXform();\n      xform.prepare(model);\n      zip.append(xform.toXml(model), {name: '/xl/workbook.xml'});\n      resolve();\n    });\n  }\n\n  _finalize() {\n    return new Promise((resolve, reject) => {\n      this.stream.on('error', reject);\n      this.stream.on('finish', () => {\n        resolve(this);\n      });\n      this.zip.on('error', reject);\n\n      this.zip.finalize();\n    });\n  }\n}\n\nasync function parseXMLFile(files, entry) {\n  const xml = (await entry.buffer()).toString();\n  const doc = new DOMParser().parseFromString(xml);\n\n  files[entry.path] = {\n    originalSrc: xml,\n    doc,\n  };\n}\n\nmodule.exports = WorkbookWriter;\n"],"mappings":"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","ignoreList":[]}