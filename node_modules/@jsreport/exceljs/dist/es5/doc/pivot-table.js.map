{"version":3,"file":"pivot-table.js","names":["objectFromProps","range","toSortedArray","require","makePivotTable","worksheet","model","validate","sourceSheet","rows","columns","values","cacheFields","makeCacheFields","nameToIndex","reduce","result","cacheField","index","name","map","row","column","value","metric","cacheId","workbook","pivotTables","length","Error","headerNames","getRow","slice","isInHeaderNames","concat","fieldNamesWithSharedItems","names","nameToHasSharedItems","aggregate","columnIndex","columnValues","getColumn","splice","columnValuesAsSet","Set","sharedItems","push","module","exports"],"sources":["../../../lib/doc/pivot-table.js"],"sourcesContent":["const {objectFromProps, range, toSortedArray} = require('../utils/utils');\n\n// TK(2023-10-10): turn this into a class constructor.\n\nfunction makePivotTable(worksheet, model) {\n  // Example `model`:\n  // {\n  //   // Source of data: the entire sheet range is taken,\n  //   // akin to `worksheet1.getSheetValues()`.\n  //   sourceSheet: worksheet1,\n  //\n  //   // Pivot table fields: values indicate field names;\n  //   // they come from the first row in `worksheet1`.\n  //   rows: ['A', 'B'],\n  //   columns: ['C'],\n  //   values: ['E'], // only 1 item possible for now\n  //   metric: 'sum', // only 'sum' possible for now\n  // }\n\n  validate(worksheet, model);\n\n  const {sourceSheet} = model;\n  let {rows, columns, values} = model;\n\n  const cacheFields = makeCacheFields(sourceSheet, [...rows, ...columns]);\n\n  // let {rows, columns, values} use indices instead of names;\n  // names can then be accessed via `pivotTable.cacheFields[index].name`.\n  // *Note*: Using `reduce` as `Object.fromEntries` requires Node 12+;\n  // ExcelJS is >=8.3.0 (as of 2023-10-08).\n  const nameToIndex = cacheFields.reduce((result, cacheField, index) => {\n    result[cacheField.name] = index;\n    return result;\n  }, {});\n  rows = rows.map(row => nameToIndex[row]);\n  columns = columns.map(column => nameToIndex[column]);\n  values = values.map(value => nameToIndex[value]);\n\n  // form pivot table object\n  return {\n    sourceSheet,\n    rows,\n    columns,\n    values,\n    metric: 'sum',\n    cacheFields,\n    // defined in <pivotTableDefinition> of xl/pivotTables/pivotTable1.xml;\n    // also used in xl/workbook.xml\n    cacheId: '10',\n  };\n}\n\nfunction validate(worksheet, model) {\n  if (worksheet.workbook.pivotTables.length === 1) {\n    throw new Error(\n      'A pivot table was already added. At this time, ExcelJS supports at most one pivot table per file.'\n    );\n  }\n\n  if (model.metric && model.metric !== 'sum') {\n    throw new Error('Only the \"sum\" metric is supported at this time.');\n  }\n\n  const headerNames = model.sourceSheet.getRow(1).values.slice(1);\n  const isInHeaderNames = objectFromProps(headerNames, true);\n  for (const name of [...model.rows, ...model.columns, ...model.values]) {\n    if (!isInHeaderNames[name]) {\n      throw new Error(`The header name \"${name}\" was not found in ${model.sourceSheet.name}.`);\n    }\n  }\n\n  if (!model.rows.length) {\n    throw new Error('No pivot table rows specified.');\n  }\n\n  if (!model.columns.length) {\n    throw new Error('No pivot table columns specified.');\n  }\n\n  if (model.values.length !== 1) {\n    throw new Error('Exactly 1 value needs to be specified at this time.');\n  }\n}\n\nfunction makeCacheFields(worksheet, fieldNamesWithSharedItems) {\n  // Cache fields are used in pivot tables to reference source data.\n  //\n  // Example\n  // -------\n  // Turn\n  //\n  //  `worksheet` sheet values [\n  //    ['A', 'B', 'C', 'D', 'E'],\n  //    ['a1', 'b1', 'c1', 4, 5],\n  //    ['a1', 'b2', 'c1', 4, 5],\n  //    ['a2', 'b1', 'c2', 14, 24],\n  //    ['a2', 'b2', 'c2', 24, 35],\n  //    ['a3', 'b1', 'c3', 34, 45],\n  //    ['a3', 'b2', 'c3', 44, 45]\n  //  ];\n  //  fieldNamesWithSharedItems = ['A', 'B', 'C'];\n  //\n  // into\n  //\n  //  [\n  //    { name: 'A', sharedItems: ['a1', 'a2', 'a3'] },\n  //    { name: 'B', sharedItems: ['b1', 'b2'] },\n  //    { name: 'C', sharedItems: ['c1', 'c2', 'c3'] },\n  //    { name: 'D', sharedItems: null },\n  //    { name: 'E', sharedItems: null }\n  //  ]\n\n  const names = worksheet.getRow(1).values;\n  const nameToHasSharedItems = objectFromProps(fieldNamesWithSharedItems, true);\n\n  const aggregate = columnIndex => {\n    const columnValues = worksheet.getColumn(columnIndex).values.splice(2);\n    const columnValuesAsSet = new Set(columnValues);\n    return toSortedArray(columnValuesAsSet);\n  };\n\n  // make result\n  const result = [];\n  for (const columnIndex of range(1, names.length)) {\n    const name = names[columnIndex];\n    const sharedItems = nameToHasSharedItems[name] ? aggregate(columnIndex) : null;\n    result.push({name, sharedItems});\n  }\n  return result;\n}\n\nmodule.exports = {makePivotTable};\n"],"mappings":"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","ignoreList":[]}